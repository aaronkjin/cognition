# EXTENSIONS_PLAN.md â€” Coupang Security Remediation Orchestrator

Prerequisite: All foundation phases (0-8 in the original PLAN.md/SPEC.md) are complete and verified. This plan extends the working system.

---

## Context

The foundation delivers a working mock-mode orchestrator + dashboard. These extensions push the project toward a production-grade demo: real Devin sessions, polished UI with dark mode and Cognition branding, API resilience, agent memory, web-based CSV upload, and enterprise analytics. Each extension is scoped for delegation to a coding subagent via a self-contained prompt.

---

## Cross-Cutting Runtime Architecture Decisions

These decisions affect multiple extensions and must be resolved before dependent work begins.

### D1. Multi-Run Source of Truth

**Problem**: `state.json` supports one run. EXT-5 (web trigger), EXT-6 (run history), and EXT-7 (analytics) require multi-run support.

**Decision**: Migrate from single `state.json` to a `runs/` directory:

```text
runs/
  <run_id>/
    state.json      # Full BatchRun for this run
    findings.csv    # Uploaded source CSV (when UI-triggered)
    pid             # Optional orchestrator process PID
    idempotency.json
  index.json        # [{run_id, started_at, status, total_findings, csv_filename}]
```

- `ProgressTracker.save_state()` writes to `runs/<run_id>/state.json` and updates `runs/index.json`.
- Canonical UI data path is `GET /api/runs` and `GET /api/runs/:id`.
- Backward compatibility: if `runs/` does not exist, fallback to top-level `state.json`.
- No DB required for demo scope.

**Depends on**: Nothing. **Blocks**: EXT-5, EXT-6, EXT-7.

### D2. Web-Run Process Lifecycle

**Problem**: Dashboard CSV upload must start orchestrator in background.

**Decision**: `POST /api/runs` spawns orchestrator via `child_process.spawn()`.

```ts
import { spawn } from "child_process";

const proc = spawn(
  "python",
  ["-m", "orchestrator.main", "run", csvPath, "--wave-size", "5"],
  {
    cwd: projectRoot,
    env: { ...process.env, STATE_FILE_PATH: `runs/${runId}/state.json` },
    detached: true,
    stdio: "ignore",
  },
);
proc.unref();
```

- Avoids introducing a FastAPI sidecar.
- `run_id` generated by API and passed via env/path.
- Dashboard polls run state file.
- Orchestrator writes PID to `runs/<run_id>/pid` for optional stop support.

**Bootstrap failure visibility contract**:

- `POST /api/runs` writes `runs/<run_id>/bootstrap.json` synchronously before returning:
  - `status: starting | failed_to_spawn | started`
  - `error` (if any)
  - `started_at`
- If spawn fails, route returns 500 with `run_id` and error details.
- UI surfaces bootstrap failures explicitly.

**Deployment constraint**:

- Requires long-lived Node runtime (`next start`, Docker, PM2).
- Not compatible with Vercel serverless/edge (`child_process.spawn` unavailable).
- Acceptable for local/self-hosted demo and VPC-oriented enterprise architecture.

### D3. API Security Middleware (Inbound) vs Devin Resilience (Outbound)

**Problem**: Different security concerns exist in different runtime layers.

**Decision**:

- **Outbound** (Python/orchestrator): resilience in `devin/client.py` (circuit breaker, jitter, Retry-After, idempotency).
- **Inbound** (Next.js): middleware for all `/api/*` routes:
  - optional bearer auth (`DASHBOARD_API_TOKEN`)
  - per-IP rate limiting (sliding window, 60 req/min)
  - mutation-route CSRF checks

**Mutation route security requirements**:

- Content-Type enforcement (`application/json` or `multipart/form-data`).
- Same-origin check for browser requests (validate `Origin`/`Referer` against configured app origin).
- Optional double-submit CSRF token header for browser session requests.

### D4. Historical Data Access Pattern

**Problem**: EXT-4 memory and EXT-7 analytics need historical data.

**Decision**:

- Both read from `runs/`.
- EXT-7 analytics aggregate from `runs/index.json` + selected run files.
- EXT-4 memory extractor reads completed run files.
- No additional data store required for demo.

### D5. Concurrent Write Safety

**Problem**: Multiple writers can race on shared files (`runs/index.json`, per-run `state.json`, memory index files).

**Decision**: Atomic writes + cross-language lock-file protocol.

- Atomic write for every shared JSON write: write temp file then rename.
- Lock files for `runs/index.json` and per-run `state.json` when HITL writes are enabled.

**Cross-language lock protocol**:

- Lock file: `<target>.lock`
- Acquire: create with exclusive mode (create-if-not-exists), retry with backoff.
- Release: remove lock file.

**Stale lock protection (safe mode)**:

- Lock file stores metadata: `{ pid, host, started_at, writer }`.
- Force-unlock allowed only if BOTH are true:
  1. lock age exceeds timeout, and
  2. owner process is verified dead on same host (when check is possible).
- Otherwise lock acquisition fails with explicit timeout error.

**Per-run state conflict resolution (deterministic)**:

- Add `version: int = 0` to `RemediationSession`.
- HITL mutation increments version for touched session.
- Tracker reloads current run file before save and merges by session `version` (higher wins).

### D6. Legacy `/api/status` Deprecation Rule

- Canonical read path: `GET /api/runs` + `GET /api/runs/:id`.
- `/api/status` remains read-only compatibility route for legacy pages.
- It returns latest run state and includes `X-Deprecated: true` response header.
- New UI code must not call `/api/status`.

---

## EXT-1: Live-First Mode (Real Devin Sessions)

**Goal**: Switch from mock-only to real Devin API sessions while preserving hybrid/mock fallback.

**Complexity**: Medium

### Scope

1. `config.py`
   - Add `hybrid_mode: bool = False`.
   - Add `connected_repos: list[str] = Field(default_factory=list)`.
   - Env format: `CONNECTED_REPOS=repo1,repo2` with `field_validator(..., mode="before")` CSV parsing.

2. `main.py`
   - Add `--live` / `--hybrid` flags.
   - `--live` => `mock_mode=False`.
   - `--hybrid` => hybrid per-finding routing.

3. `session_manager.py`
   - Normalize real Devin response fields (`status_enum`, nested `pull_request.url`, `structured_output`).

4. `poller.py`
   - Map `working`, `blocked`, `finished`, `expired` into `SessionStatus`.

5. `preflight.py` (new)
   - Reusable `preflight_check(client, config, findings) -> list[str]`:
     - API key present
     - Devin connectivity (`GET /v1/sessions?limit=1`)
     - required playbooks exist
     - `connected_repos` non-empty in hybrid mode

6. Data provenance
   - Add `data_source` to `RemediationSession` (`live|mock`).
   - Add run-level `BatchRun.data_source` (`live|mock|hybrid`).
   - Dashboard indicator badge in header/session detail.

7. Hybrid determinism
   - Determine per-finding mode by repo allowlist match.
   - Log each finding decision at INFO.

8. Demo readiness
   - Add `scripts/validate_state.py`:
     - session IDs present
     - data source set
     - status sanity checks
     - orphan/malformed detection

### Key files

- `orchestrator/config.py`
- `orchestrator/main.py`
- `orchestrator/preflight.py` (new)
- `orchestrator/devin/session_manager.py`
- `orchestrator/monitor/poller.py`
- `orchestrator/models.py`
- `dashboard/lib/types.ts`
- `dashboard` header/overview component(s) for mode badge
- `scripts/validate_state.py` (new)
- `.env.example` (add `CONNECTED_REPOS` docs)

### Acceptance criteria

- `--live` runs real Devin sessions.
- Preflight fails fast with actionable errors.
- `--hybrid` deterministic per-finding mode based on `connected_repos`.
- `data_source` fields present in run + sessions.
- Dashboard shows mode badge.
- `validate_state.py` works on completed runs.
- Existing mock-mode tests still pass.

---

## EXT-2: UI Polish (Dark Mode, Collapsible Sidebar, Cognition Branding)

**Goal**: Visual wow-factor with cohesive dark mode and branding.

**Complexity**: Medium

### Scope

1. Theme mechanism
   - Add `dashboard/lib/theme.tsx` ThemeProvider.
   - Persist theme in localStorage.
   - Toggle dark class on root element.

2. Phase 1 mandatory semantic migration (demo-critical)
   - `layout.tsx`, `sidebar.tsx`, `overview-cards.tsx`, `status-badge.tsx`, `sessions-table.tsx`, `findings-table.tsx`, `trace-timeline.tsx`, `pr-queue.tsx`.
   - Replace hardcoded gray utilities with semantic token classes.

3. Collapsible sidebar
   - `w-64` expanded, `w-16` collapsed.
   - Persist preference in localStorage.
   - Icon-only collapsed state.

4. Cognition branding
   - Use `dashboard/public/cognition-logo.png`.
   - Favicon from Cognition logo.
   - Title: `Coupang Security Remediation | Cognition`.

### Key files

- `dashboard/lib/theme.tsx` (new)
- `dashboard/app/layout.tsx`
- `dashboard/components/sidebar.tsx`
- listed phase-1 components
- `dashboard/public/cognition-logo.png`
- `dashboard/app/favicon.ico`

### Acceptance criteria

- Dark mode toggle works and persists.
- All phase-1 components look correct in both themes.
- Sidebar collapse is smooth and usable.
- Cognition logo + favicon are wired.
- `npm run build` passes.

---

## EXT-3: Scale & Security Hardening

**Goal**: Resilient Devin API usage and safe orchestrator behavior.

**Complexity**: Medium

### Scope

1. Client resilience
   - Retry jitter.
   - Retry-After support.
   - Circuit breaker (`closed/open/half-open`).
   - Retry on `429`, `500-503` with bounded retries.

2. Config additions
   - `circuit_breaker_threshold`
   - `circuit_breaker_cooldown_seconds`
   - `max_retries`
   - `retry_jitter_max_seconds`

3. Deterministic idempotency ledger
   - Add run-scoped `runs/<run_id>/idempotency.json` ledger.
   - Key: `{run_id}-{finding_id}-attempt-{attempt}`.
   - Session creation checks ledger first (fast/local), then optional API lookup.
   - Prevent duplicate session creation during retries/restarts.

4. Graceful shutdown
   - Catch interruption, persist `interrupted` state, do not force-kill remote Devin sessions.

### Key files

- `orchestrator/devin/client.py`
- `orchestrator/config.py`
- `orchestrator/planner/wave_manager.py`
- `orchestrator/devin/session_manager.py` (idempotency integration)
- `tests/test_client.py` (new/expanded)

### Acceptance criteria

- Circuit breaker behavior verified.
- Jitter and Retry-After respected.
- No duplicate session creation under retry.
- Ctrl+C persists recoverable state.
- Existing tests still pass.

---

## EXT-4: Memory Layer for Agents

**Goal**: Cross-run learning with metadata graph + markdown memory items.

**Complexity**: Medium

### Scope

1. Filesystem memory graph

```text
orchestrator/memory/
  graph.json
  items/
    FIND-0001.md
```

- `graph.json` metadata-only index.
- full narrative content in `items/*.md`.

2. Models

- `MemoryItem`, `MemoryGraph`, `MemoryGraphEntry`, `MemoryRelationship`.
- Include `data_source` (`live|mock`) and `created_at`.
- Use `Field(default_factory=...)` for mutable fields.

3. Extraction + storage

- Extract memory from terminal sessions.
- Save markdown + update graph.

4. Retrieval quality controls

- Prefer `live` memories.
- If only `mock` exists, include explicit prompt note.
- Rank by relevance + confidence + freshness decay.
- Inject source citation in prompt context.

### Key files

- `orchestrator/memory/__init__.py` (new)
- `orchestrator/memory/store.py` (new)
- `orchestrator/memory/extractor.py` (new)
- `orchestrator/models.py`
- `orchestrator/monitor/tracker.py`
- `orchestrator/devin/session_manager.py`
- `tests/test_memory.py` (new)

### Acceptance criteria

- Memory artifacts generated after runs.
- Graph remains metadata-only.
- Prompt enrichment uses ranked, cited memory context.
- Data source contamination handling works.
- Existing pipeline still passes tests.

---

## EXT-5: Agentic UI (CSV Upload from Dashboard)

**Goal**: End users trigger remediation from UI without needing CLI.

**Complexity**: High

### Scope

1. API routes

- `POST /api/runs`: upload CSV + start run.
- `GET /api/runs`: list runs (`runs/index.json`).
- `GET /api/runs/:id`: return run state.

2. Upload security + validation

- Max size 10MB.
- Max row count 5,000.
- Parse timeout 10s.
- MIME/extension checks.
- Required-column schema validation.
- Path traversal-safe writes.

3. UI flow

- Upload modal/dropzone.
- Optional wave-size field.
- Start run and navigate to run view.
- Run selector for historical runs.

4. Canonical API migration

- New UI reads only `/api/runs` + `/api/runs/:id`.
- `/api/status` compatibility only (deprecated header).

5. Inbound security middleware (applies to all `/api/*`)

- Optional bearer auth.
- Per-IP rate limiting.
- Mutation-route CSRF checks (origin/referrer allowlist + token strategy where applicable).
- Content-Type enforcement.

### Key files

- `dashboard/app/api/runs/route.ts` (new)
- `dashboard/app/api/runs/[id]/route.ts` (new)
- `dashboard/middleware.ts` (new)
- `dashboard/lib/file-lock.ts` (new, D5 protocol)
- `dashboard/components/upload-modal.tsx` (new)
- `dashboard/components/run-selector.tsx` (new)
- `dashboard/lib/use-status.ts`
- `dashboard/app/api/status/route.ts` (deprecation behavior)
- `dashboard/components/sidebar.tsx`
- `orchestrator/monitor/tracker.py` (runs path/index updates)

### Acceptance criteria

- Upload -> run start -> live progress works.
- Run listing and selector work.
- Security controls enforced on mutation routes.
- Legacy `/api/status` compatibility intact but deprecated.
- Existing tests pass.

---

## EXT-6: Enterprise Extensions (Run History + ROI)

**Goal**: Executive-facing visibility across runs.

**Complexity**: Medium

### Scope

1. Run history page

- `history` table from `GET /api/runs`.
- fields: run ID, started, status, totals, success rate, PR count, duration.

2. ROI card

- engineer-hours saved = `successful_findings * 3`.
- cost saved = `engineer_hours * 80`.

3. Comparison (stretch)

- side-by-side run comparison.

### Key files

- `dashboard/app/history/page.tsx` (new)
- `dashboard/components/roi-card.tsx` (new)
- `dashboard/components/sidebar.tsx`
- `dashboard/app/page.tsx`
- `dashboard/lib/types.ts`

### Acceptance criteria

- History page accurate.
- ROI card accurate and understandable.
- Sidebar links updated.
- Existing tests pass.

---

## EXT-7A: Evaluation Harness + SLO/Ops View

**Goal**: Quantified quality + operational health.

**Complexity**: Medium

### Scope

1. Evaluation harness

- Aggregate per-category pass/fail, duration, retries, confidence.
- Compute `health` from threshold bands.

2. Eval dashboard

- Category table + health badge.
- Critical banner if any category is critical.

3. Ops view

- p50/p95 durations.
- throughput (sessions/hour).
- projected completion.
- ACU burn rate and budget remaining.

4. Formula edge guards

- no divide-by-near-zero.
- low sample markers.
- fallback labels (`Calculating...`, `Not enough data`, `---`).

### Key files

- `orchestrator/eval/__init__.py` (new)
- `orchestrator/eval/harness.py` (new)
- `dashboard/app/eval/page.tsx` (new)
- `dashboard/app/ops/page.tsx` (new)
- `dashboard/app/api/eval/route.ts` (new)
- `dashboard/lib/types.ts`
- `orchestrator/models.py` (eval metric model)

### Acceptance criteria

- Eval page shows per-category metrics and health.
- Ops page shows metrics with edge-case guards.
- Threshold alerts render correctly.
- Existing tests pass.

---

## EXT-7B: HITL Approval + Per-Service Playbook Adaptation

**Goal**: Governance workflow + service-specific playbook behavior.

**Complexity**: Medium

### Scope

1. HITL approval fields

- `review_status`: pending|approved|rejected
- `reviewed_by`: derived from authenticated identity, not request body
- `reviewed_at`
- `review_reason`
- `version` increment for mutation ordering (D5)

2. Review API

- `POST /api/sessions/:id/review`
- accepts `action`, `reason`
- reviewer identity from auth context/token claims
- atomic write + lock protocol
- append audit event to run timeline

3. Review UI

- approve/reject actions with optional reason.
- status badge + reviewer metadata.

4. Service playbook adaptation

- `service_overrides.json` for service-specific controls.
- inject overrides into session prompt context.
- show applied overrides in session detail UI.

### Key files

- `orchestrator/models.py`
- `service_overrides.json` (new)
- `orchestrator/devin/session_manager.py`
- `dashboard/app/api/sessions/[id]/review/route.ts` (new)
- `dashboard/app/review/page.tsx`
- `dashboard/components/sidebar.tsx`
- `dashboard/lib/types.ts`

### Acceptance criteria

- HITL decisions persist with proper reviewer attribution.
- audit events emitted for review actions.
- no lost review updates under concurrent tracker writes.
- service overrides are applied and visible.
- existing tests pass.

---

## Priority & Dependency Table

| Extension              | Priority | Effort  | Demo Impact           | Depends On     | Batch |
| ---------------------- | -------- | ------- | --------------------- | -------------- | ----- |
| EXT-2 UI Polish        | P0       | Medium  | High (visual wow)     | None           | 1     |
| EXT-1 Live Mode        | P0       | Low-Med | High (real Devin)     | None           | 1     |
| EXT-3 Hardening        | P1       | Medium  | Medium (resilience)   | None           | 2a    |
| EXT-6 History/ROI      | P1       | Medium  | High (enterprise)     | D1             | 2a    |
| EXT-4 Memory           | P2       | Medium  | Medium (intelligence) | EXT-6          | 2b    |
| EXT-5 Agentic UI       | P2       | High    | High (self-serve)     | D1, D2, D3, D6 | 3a    |
| EXT-7A Eval+Ops        | P2       | Medium  | High (analytics)      | D1, EXT-6      | 3a    |
| EXT-7B HITL+Adaptation | P2       | Medium  | High (governance)     | D1, D5, EXT-5  | 3b    |

---

## Dependency Graph

```text
EXT-2 (UI) ---------------------+
EXT-1 (Live) -------------------+--> Batch 1 (parallel)

EXT-3 (Hardening) --------------+
EXT-6 (History/ROI) ------------+--> Batch 2a (parallel)

EXT-4 (Memory) --------------------> Batch 2b (after EXT-6)

EXT-5 (Agentic UI) -------------+
EXT-7A (Eval + Ops) ------------+--> Batch 3a (parallel)

EXT-7B (HITL + Adaptation) --------> Batch 3b (after EXT-5 + 7A)
```

---

## Conflict Zone Map

- `dashboard/components/sidebar.tsx`
  - EXT-2, EXT-5, EXT-6, EXT-7A/7B
  - Sequence: `EXT-2 -> EXT-6 -> EXT-5 -> EXT-7*`

- `orchestrator/monitor/tracker.py`
  - EXT-6 (run path/index), EXT-4 (memory hooks), EXT-7B (review merge/version)
  - Sequence: `EXT-6 -> EXT-4 -> EXT-7B`

- `orchestrator/devin/session_manager.py`
  - EXT-1 (live/hybrid), EXT-3 (idempotency), EXT-4 (memory retrieval), EXT-7B (service overrides)
  - Sequence: `EXT-1 -> EXT-3 -> EXT-4 -> EXT-7B`

- `dashboard/lib/types.ts`
  - EXT-1/6/7 additive changes; merge-safe if rebased.

---

## Batch Execution Strategy

### Batch 1 (parallel)

- Prompt 1: EXT-1 Live-First
- Prompt 2: EXT-2 UI Polish

### Batch 2a (parallel)

- Prompt 3: EXT-3 Hardening
- Prompt 6: EXT-6 History/ROI (includes D1 migration)

### Batch 2b (sequential)

- Prompt 4: EXT-4 Memory (after EXT-6)

### Batch 3a (parallel)

- Prompt 5: EXT-5 Agentic UI
- Prompt 7A: EXT-7A Eval+Ops

### Batch 3b (sequential)

- Prompt 7B: EXT-7B HITL+Adaptation (after EXT-5 + 7A)

Implementation note: When multiple prompts add nav items, append at end of nav array to reduce merge conflicts.

---

## Verification Plan

1. **Batch 1**
   - Build passes.
   - dark mode + collapse + branding verified.
   - live/hybrid preflight and data-source markers verified.

2. **Batch 2a**
   - runs directory migration works.
   - history and ROI visible.
   - resilience behavior tested (429/5xx/retry/circuit).

3. **Batch 2b**
   - memory graph + markdown items generated.
   - retrieval uses freshness/confidence/source filters.

4. **Batch 3a**
   - CSV upload starts runs securely.
   - canonical `/api/runs` path used by UI.
   - eval and ops pages produce valid outputs.

5. **Batch 3b**
   - review actions persist with proper reviewer attribution.
   - audit events logged.
   - lock protocol prevents lost updates.
   - service overrides appear in prompt/UI.

---

## End-to-End Smoke Test (post all batches)

```bash
# Terminal 1
cd dashboard && npm run dev

# Terminal 2 (CLI fallback still supported)
python -m orchestrator.main run sample_data/findings.csv --wave-size 5
```

Verify in browser:

1. Dashboard progress updates for selected run ID.
2. Sidebar contains: Dashboard, Findings, Sessions, Review, History, Eval, Ops.
3. History includes completed run.
4. Eval page shows category health metrics.
5. Ops page shows p50/p95/throughput and alert badges.
6. Memory files exist under `orchestrator/memory/`.
7. HITL approvals update state and audit timeline.
